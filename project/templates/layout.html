<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}ë¸”ë¡ì½”ë”© AI íŒŒì´í”„ë¼ì¸{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <div class="sidebar">
    {% include 'sidebar.html' %}
  </div>

  <div class="main">
    <div class="tabs">
      <button id="tab-code" class="active">ì½”ë“œ</button>
      <button id="tab-data">ë°ì´í„° êµ¬ì¡°</button>
      <!-- ğŸ”¹ ë¡œê·¸ íƒ­ ì¶”ê°€ -->
      <button id="tab-log">ë¡œê·¸</button>
    </div>

    <div id="content-code" class="tab-content active">
      {% include 'main_code.html' %}
    </div>

    <div id="content-data" class="tab-content">
      {% include 'main_data.html' %}
    </div>

    <!-- ğŸ”¹ ë¡œê·¸ ì»¨í…ì¸  ì¶”ê°€ -->
    <div id="content-log" class="tab-content">
      {% include 'main_log.html' %}
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
  <script src="{{ url_for('static', filename='js/data_info.js') }}"></script>
  <!-- ğŸ”¹ ë¡œê·¸ ì‹¤í–‰/SSE ìŠ¤íŠ¸ë¦¼ JS ì¶”ê°€ -->
  <script src="{{ url_for('static', filename='js/logs.js') }}"></script>


  
  <script>
    (function(){
      // ---- ì‚¬ìš©ìë³„ í‚¤ (uid ì¿ í‚¤ ì—†ìœ¼ë©´ guest) ----
      function getCookie(name){
        const m = document.cookie.match(new RegExp('(?:^|; )'+name+'=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : '';
      }
      const uid = getCookie('uid') || 'guest';
      const KEY_MAIN = `aiBlocks:main:${uid}`;   
      const KEY_LEFT = `aiBlocks:left:${uid}`;   
      const KEY_CODE = `aiBlocks:code:${uid}`;   
      const KEY_FORM = `aiBlocks:form:${uid}`;

      // ---- í¼ ê°’ ì €ì¥/ë³µì› (LocalStorage) ----
      function saveForm(){
        const form = document.querySelector('form');
        if(!form) return;
        const data = {};
        const fd = new FormData(form);
        for (const [k,v] of fd.entries()){
          if (k in data){
            Array.isArray(data[k]) ? data[k].push(v) : data[k]=[data[k], v];
          } else data[k]=v;
        }
        localStorage.setItem(KEY_FORM, JSON.stringify(data));
      }
      
      function restoreForm(){
        const form = document.querySelector('form');
        if(!form) return;
        const raw = localStorage.getItem(KEY_FORM);
        if(!raw) return;
        let s; try{s=JSON.parse(raw)}catch(e){return;}
        for (const [name,val] of Object.entries(s)){
          const nodes = form.querySelectorAll(`[name="${name}"]`);
          if(!nodes.length) continue;
          nodes.forEach(el=>{
            const type=(el.type||'').toLowerCase(), tag=el.tagName.toLowerCase();
            if (type==='checkbox'){
              if (Array.isArray(val)) el.checked = val.map(String).includes(String(el.value));
              else el.checked = (String(val)==='on' || String(val)==='true' || String(val)===String(el.value));
            } else if (type==='radio'){
              el.checked = (String(el.value)===String(val));
            } else if (tag==='select'){
              if (el.multiple && Array.isArray(val)){
                [...el.options].forEach(opt => opt.selected = val.map(String).includes(String(opt.value)));
              } else el.value = val;
            } else {
              el.value = Array.isArray(val) ? val[0] : val;
            }
            el.dispatchEvent(new Event('change',{bubbles:true}));
          });
        }
      }

      // ---- íƒ­ ì €ì¥/ë³µì› ----
      function switchTab(active){  
        document.getElementById('tab-code')?.classList.toggle('active', active==='code');
        document.getElementById('tab-data')?.classList.toggle('active', active==='data');
        document.getElementById('tab-log') ?.classList.toggle('active', active==='log');

        document.getElementById('content-code')?.classList.toggle('active', active==='code');
        document.getElementById('content-data')?.classList.toggle('active', active==='data');
        document.getElementById('content-log') ?.classList.toggle('active', active==='log');
      }

      function restoreTabs(){
        const main = localStorage.getItem(KEY_MAIN);
        if (main==='data') document.getElementById('tab-data')?.click();
        else if (main==='log') document.getElementById('tab-log')?.click();
        else document.getElementById('tab-code')?.click();

        const code = localStorage.getItem(KEY_CODE) || 'pre';
        document.querySelector(`.stage-tab[data-stage="${code}"]`)?.click();

        const left = localStorage.getItem(KEY_LEFT) || 'pre';
        document.querySelector(`.left-tab[data-tab="${left}"]`)?.click();
      }

      // DOM ì¤€ë¹„ë˜ë©´ í¼ ë³µì› + ì´ë²¤íŠ¸ ë“±ë¡
      document.addEventListener('DOMContentLoaded', ()=>{
        restoreForm();
        const form = document.querySelector('form');
        if (form){
          form.addEventListener('input',  saveForm);
          form.addEventListener('change', saveForm);
          // ğŸ”¹ ê¸°ì¡´ submit ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (AJAXë¡œ ëŒ€ì²´)
          // form.addEventListener('submit', ()=>{...}); // ì´ ë¶€ë¶„ ì‚­ì œ
        }

        // íƒ­ í´ë¦­ ì‹œ ì €ì¥
        document.getElementById('tab-code')?.addEventListener('click', ()=>{localStorage.setItem(KEY_MAIN,'code'); switchTab('code');});
        document.getElementById('tab-data')?.addEventListener('click', ()=>{localStorage.setItem(KEY_MAIN,'data'); switchTab('data');});
        document.getElementById('tab-log') ?.addEventListener('click', ()=>{localStorage.setItem(KEY_MAIN,'log');  switchTab('log'); });

        document.querySelectorAll('.stage-tab').forEach(b=>{
          b.addEventListener('click', ()=> localStorage.setItem(KEY_CODE, b.dataset.stage||'pre'));
        });
        document.querySelectorAll('.left-tab').forEach(b=>{
          b.addEventListener('click', ()=> localStorage.setItem(KEY_LEFT, b.dataset.tab||'pre'));
        });
      });

      // ëª¨ë“  ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ê°€ ëë‚œ ë’¤ ìµœì¢… ë³µì›
      window.addEventListener('load', restoreTabs);
    })();
  </script>
</body>
</html>