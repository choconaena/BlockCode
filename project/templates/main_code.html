<div class="stage-tabs">
  <button class="stage-tab active" data-stage="pre">전처리</button>
  <button class="stage-tab" data-stage="model">모델 설계</button>
  <button class="stage-tab" data-stage="train">학습</button>
  <button class="stage-tab" data-stage="eval">평가</button>
</div>

<!-- Preprocessing 코드 -->
<div class="stage-pane" id="pane-code-pre">
  <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
    <!-- 🔹 다운로드 링크를 버튼으로 변경 (JavaScript로 처리) -->
    <button class="btn" onclick="downloadCode('pre')">preprocessing.py 다운로드</button>
    <button class="btn btn-run" data-run="pre">이 단계 실행</button>
    <button class="btn" onclick="document.getElementById('tab-log').click()">로그 보기</button>
  </div>
  <pre class="code" id="code-pre">{% if snippet_pre %}{{ snippet_pre | e }}{% else %}# 전처리 코드가 생성되면 여기에 표시됩니다.{% endif %}</pre>
</div>

<!-- ModelDesign 코드 -->
<div class="stage-pane" id="pane-code-model" hidden>
  <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
    <button class="btn" onclick="downloadCode('model')">model.py 다운로드</button>
    <button class="btn btn-run" data-run="model">이 단계 실행</button>
    <button class="btn" onclick="document.getElementById('tab-log').click()">로그 보기</button>
  </div>
  <pre class="code" id="code-model">{% if snippet_model %}{{ snippet_model | e }}{% else %}# 모델 설계 코드가 생성되면 여기에 표시됩니다.{% endif %}</pre>
</div>

<!-- Training 코드 -->
<div class="stage-pane" id="pane-code-train" hidden>
  <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
    <button class="btn" onclick="downloadCode('train')">training.py 다운로드</button>
    <button class="btn btn-run" data-run="train">이 단계 실행</button>
    <button class="btn" onclick="document.getElementById('tab-log').click()">로그 보기</button>
  </div>
  <pre class="code" id="code-train">{% if snippet_train %}{{ snippet_train | e }}{% else %}# 학습 코드가 생성되면 여기에 표시됩니다.{% endif %}</pre>
</div>

<!-- Evaluation 코드 -->
<div class="stage-pane" id="pane-code-eval" hidden>
  <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
    <button class="btn" onclick="downloadCode('eval')">evaluation.py 다운로드</button>
    <button class="btn btn-run" data-run="eval">이 단계 실행</button>
    <button class="btn" onclick="document.getElementById('tab-log').click()">로그 보기</button>
  </div>
  <pre class="code" id="code-eval">{% if snippet_eval %}{{ snippet_eval | e }}{% else %}# 평가 코드가 생성되면 여기에 표시됩니다.{% endif %}</pre>
</div>

<!-- 🔹 다운로드 함수 추가 -->
<script>
function downloadCode(stage) {
  // 사용자 ID 가져오기
  const userIdInput = document.getElementById('user-id-input');
  const userId = userIdInput ? userIdInput.value.trim() || 'anonymous' : 'anonymous';
  
  if (userId === 'anonymous') {
    alert('사용자 ID를 입력해주세요!');
    if (userIdInput) userIdInput.focus();
    return;
  }
  
  // 사용자 ID를 포함한 다운로드 URL
  const downloadUrl = `/download/${stage}?user_id=${encodeURIComponent(userId)}`;
  
  // 새 창에서 다운로드
  window.open(downloadUrl, '_blank');
}

// 전체 다운로드 함수도 추가
function downloadAll() {
  const userIdInput = document.getElementById('user-id-input');
  const userId = userIdInput ? userIdInput.value.trim() || 'anonymous' : 'anonymous';
  
  if (userId === 'anonymous') {
    alert('사용자 ID를 입력해주세요!');
    if (userIdInput) userIdInput.focus();
    return;
  }
  
  const downloadUrl = `/download/all?user_id=${encodeURIComponent(userId)}`;
  window.open(downloadUrl, '_blank');
}
</script>