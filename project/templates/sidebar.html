<!-- 🔹 사용자 ID 입력 섹션 추가 -->
<div style="background:#e3f2fd; padding:0.75rem; margin-bottom:1rem; border-radius:5px; border:2px solid #1976d2;">
  <h3 style="margin:0 0 0.5rem 0; color:#1976d2; font-size:1rem;">👤 사용자 식별</h3>
  <label>사용자 ID:</label>
  <input type="text" 
         id="user-id-input" 
         name="user_id" 
         value="{{ current_user_id or 'anonymous' }}" 
         placeholder="예: hong_gildong" 
         pattern="[a-zA-Z0-9_-]+" 
         title="영문, 숫자, _, - 만 사용 가능"
         style="width:100%; padding:0.5rem; margin-top:0.25rem; border:1px solid #ccc; border-radius:3px;">
  <small style="color:#666; font-size:0.85em;">
    * 영문, 숫자, _, - 만 사용 가능<br>
    * 이 ID로 작업 파일이 저장됩니다
  </small>
</div>

<form method="post" action="/convert">
  <!-- 좌측 대분류 탭 -->
  <div class="left-tabs">
    <button type="button" class="left-tab active" data-tab="pre">🟩 데이터 전처리</button>
    <button type="button" class="left-tab"        data-tab="model">🟦 모델 설계</button>
    <button type="button" class="left-tab"        data-tab="train">🟧 학습하기</button>
    <button type="button" class="left-tab"        data-tab="eval">🟥 평가하기</button>
  </div>

  <!-- 각 탭별 블록 컨텐츠 -->
  <div class="left-content">
<!------------------------------------------------------ 🟩 데이터 전처리 Pane ------------------------------------------------------>
    <!-- 🟩 데이터 전처리 Pane -->
    <div class="pane" id="pane-pre">
      <!-- ① 데이터 선택 (항상 활성/필수) -->
      <div class="block block-pre block-required" id="block-data-selection" data-active="true">
        <h3>데이터 선택</h3>
        <label>훈련 CSV:</label>
        <select name="dataset">
          {% for f in options %}<option>{{f}}</option>{% endfor %}
        </select>

        <label style="margin-top:0.5rem;">테스트 사용 여부:</label>
        <select id="is_test" name="is_test">
          <option value="false">아니요</option>
          <option value="true">예</option>
        </select>

        <div id="test-div" style="display:none; margin:0.5rem 0;">
          <label>테스트 CSV:</label>
          <select name="testdataset">
            {% for f in options %}<option>{{f}}</option>{% endfor %}
          </select>
        </div>

        <div id="ratio-div" style="margin:0.5rem 0;">
          <label>학습 비율 a%:</label>
          <input type="number" name="a" value="80" min="1" max="99">
        </div>
      </div>

      <!-- ② 빈 데이터 삭제 -->
      <div class="block block-pre" id="block-drop-na" data-active="true">
        <h3>빈 데이터 삭제</h3>
        <label><input type="checkbox" name="drop_na"> 빈 데이터(결측치) 삭제</label>
      </div>

      <!-- ③ 잘못된 라벨 삭제 -->
      <div class="block block-pre" id="block-drop-bad" data-active="true">
        <h3>잘못된 라벨 삭제</h3>
        <label><input type="checkbox" id="drop_bad" name="drop_bad"> 라벨 범위 필터링</label>
        <div id="drop_bad_params" style="display:none; margin-top:0.5rem;">
          <label>최소 라벨:<input type="number" name="min_label" value="0" min="0"></label>
          <label style="margin-left:0.5rem;">최대 라벨:<input type="number" name="max_label" value="9" min="0"></label>
        </div>
      </div>

      <!-- ④ 입력/라벨 분리 -->
      <div class="block block-pre" id="block-split-xy" data-active="true">
        <h3>입력/라벨 분리</h3>
        <label><input type="checkbox" name="split_xy" checked> 분리</label>
      </div>

      <!-- ⑤ 이미지 크기 변경 -->
      <div class="block block-pre" id="block-resize" data-active="true">
        <h3>이미지 크기 변경</h3>
        <label>n:<input type="number" name="resize_n" value="28" min="1"></label>
      </div>

      <!-- ⑥ 이미지 증강 -->
      <div class="block block-pre" id="block-augment" data-active="true">
        <h3>이미지 증강</h3>
        <select name="augment_method">
          <option value="">선택</option>
          <option value="rotate">rotate</option>
          <option value="hflip">hflip</option>
          <option value="vflip">vflip</option>
          <option value="translate">translate</option>
        </select>
        <input type="number" name="augment_param" value="5" min="1" style="margin-left:0.5rem;">
      </div>

      <!-- ⑦ 픽셀 값 정규화 -->
      <div class="block block-pre" id="block-normalize" data-active="true">
        <h3>픽셀 값 정규화</h3>
        <select name="normalize">
          <option value="">선택</option>
          <option value="0-1">0~1</option>
          <option value="-1-1">-1~1</option>
        </select>
      </div>
    </div>
<!------------------------------------------------------ 🟦 모델 설계 Pane ------------------------------------------------------>
    <!-- 🟦 모델 설계 Pane -->
    <div class="pane" id="pane-model" hidden>
      <!-- (필수) 입력층 -->
      <div class="block block-model block-required" id="block-input" data-active="true">
        <h3>입력층 설정</h3>
        <label>가로(W): <input type="number" name="input_w" value="28" min="1"></label>
        <label style="margin-left:0.5rem;">세로(H): <input type="number" name="input_h" value="28" min="1"></label>
        <label style="margin-left:0.5rem;">채널: 
          <select name="input_c">
            <option value="1" selected>1 (흑백)</option>
            <option value="3">3 (컬러)</option>
          </select>
        </label>
      </div>

      <!-- 합성곱 블록 #1 -->
      <div class="block block-model" id="block-conv1" data-active="true">
        <h3>이미지 특징 찾기 (Conv2D #1)</h3>
        <label>필터 수: <input type="number" name="conv1_filters" value="32" min="1"></label>
        <label style="margin-left:0.5rem;">커널: 
          <select name="conv1_kernel">
            <option value="3">3x3</option>
            <option value="5">5x5</option>
            <option value="7">7x7</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">스트라이드:
          <input type="number" name="conv1_stride" value="1" min="1">
        </label>
        <label style="margin-left:0.5rem;">패딩:
          <select name="conv1_padding">
            <option value="same">same</option>
            <option value="valid">valid</option>
          </select>
        </label>
        <label style="display:block; margin-top:0.5rem;">활성함수:
          <select name="conv1_activation">
            <option value="relu" selected>ReLU</option>
            <option value="tanh">tanh</option>
            <option value="sigmoid">sigmoid</option>
            <option value="none">없음</option>
          </select>
        </label>
      </div>

      <!-- 풀링 #1 -->
      <div class="block block-model" id="block-pool1" data-active="true">
        <h3>특징 크기 줄이기 (Pooling #1)</h3>
        <label>종류:
          <select name="pool1_type">
            <option value="max" selected>Max</option>
            <option value="avg">Avg</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">크기:
          <select name="pool1_size">
            <option value="2" selected>2x2</option>
            <option value="3">3x3</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">스트라이드:
          <input type="number" name="pool1_stride" value="2" min="1">
        </label>
      </div>

      <!-- 합성곱 블록 #2 (선택) -->
      <div class="block block-model" id="block-conv2" data-active="false">
        <h3>이미지 특징 찾기 (Conv2D #2)</h3>
        <label>사용:
          <input type="checkbox" name="use_conv2">
        </label>
        <div style="margin-top:0.5rem;">
          <label>필터 수: <input type="number" name="conv2_filters" value="64" min="1"></label>
          <label style="margin-left:0.5rem;">커널:
            <select name="conv2_kernel">
              <option value="3">3x3</option>
              <option value="5">5x5</option>
            </select>
          </label>
          <label style="margin-left:0.5rem;">활성함수:
            <select name="conv2_activation">
              <option value="relu" selected>ReLU</option>
              <option value="tanh">tanh</option>
              <option value="sigmoid">sigmoid</option>
              <option value="none">없음</option>
            </select>
          </label>
        </div>
      </div>

      <!-- 드롭아웃 -->
      <div class="block block-model" id="block-dropout" data-active="false">
        <h3>헷갈림 방지하기 (Dropout)</h3>
        <label>사용: <input type="checkbox" name="use_dropout"></label>
        <label style="margin-left:0.5rem;">비율:
          <input type="number" name="dropout_p" value="0.25" min="0" max="0.9" step="0.05">
        </label>
      </div>

      <!-- 펼치기 -->
      <div class="block block-model" id="block-flatten" data-active="true">
        <h3>특징 펼치기 (Flatten)</h3>
        <p style="margin:0;">합성곱 출력을 1차원으로 변환</p>
      </div>

      <!-- 완전연결(Dense) -->
      <div class="block block-model" id="block-dense" data-active="true">
        <h3>분류 준비하기 (Dense)</h3>
        <label>유닛 수:
          <input type="number" name="dense_units" value="128" min="1">
        </label>
        <label style="margin-left:0.5rem;">활성함수:
          <select name="dense_activation">
            <option value="relu" selected>ReLU</option>
            <option value="tanh">tanh</option>
            <option value="sigmoid">sigmoid</option>
            <option value="none">없음</option>
          </select>
        </label>
      </div>

      <!-- (필수) 출력층 -->
      <div class="block block-model block-required" id="block-output" data-active="true">
        <h3>정답 예측층 (Output)</h3>
        <label>클래스 수: <input type="number" name="num_classes" value="10" min="2"></label>
        <label style="margin-left:0.5rem;">활성함수:
          <select name="output_activation">
            <option value="softmax" selected>softmax</option>
            <option value="none">없음 (CrossEntropy 등에서 내부 처리)</option>
          </select>
        </label>
      </div>
    </div>

<!------------------------------------------------------ 🟧 학습하기 Pane ------------------------------------------------------>
    <!-- 🟧 학습하기 Pane -->
    <div class="pane" id="pane-train" hidden>
      <!-- (필수) 손실 함수 -->
      <div class="block block-train block-required" id="block-loss" data-active="true">
        <h3>손실함수 선택</h3>
        <select name="loss_method">
          <option value="CrossEntropy" selected>CrossEntropy (다중분류)</option>
          <option value="MSE">MSE (회귀/특수케이스)</option>
        </select>
      </div>

      <!-- (필수) 옵티마이저 -->
      <div class="block block-train block-required" id="block-optim" data-active="true">
        <h3>옵티마이저</h3>
        <label>종류:
          <select name="optimizer_method">
            <option value="Adam" selected>Adam</option>
            <option value="SGD">SGD</option>
            <option value="RMSprop">RMSprop</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">학습률:
          <input type="number" name="learning_rate" value="0.00001" min="0.00001" step="0.0001">
        </label>
        <label style="margin-left:0.5rem;">가중감쇠(Weight Decay):
          <input type="number" name="weight_decay" value="0.0" min="0" step="0.0001">
        </label>
        <label style="margin-left:0.5rem;">모멘텀(SGD):
          <input type="number" name="momentum" value="0.9" min="0" max="0.999" step="0.01">
        </label>
      </div>

      <!-- (필수) 학습 옵션 -->
      <div class="block block-train block-required" id="block-train-options" data-active="true">
        <h3>학습 옵션</h3>
        <label>Epochs:
          <input type="number" name="epochs" value="10" min="1" max="200">
        </label>
        <label style="margin-left:0.5rem;">Batch Size:
          <input type="number" name="batch_size" value="64" min="1" max="1024">
        </label>
        <label style="margin-left:0.5rem;">EarlyStopping Patience:
          <input type="number" name="patience" value="3" min="0" max="20">
        </label>
        <label style="margin-left:0.5rem;">Shuffle:
          <select name="shuffle">
            <option value="true" selected>True</option>
            <option value="false">False</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">Seed:
          <input type="number" name="seed" value="42" min="0">
        </label>
      </div>

      <!-- 스케줄러(선택) -->
      <div class="block block-train" id="block-scheduler" data-active="false">
        <h3>러닝레이트 스케줄러 (선택)</h3>
        <label>종류:
          <select name="sched_type">
            <option value="">없음</option>
            <option value="step">StepLR</option>
            <option value="cosine">CosineAnnealingLR</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">step_size:
          <input type="number" name="sched_step" value="5" min="1">
        </label>
        <label style="margin-left:0.5rem;">gamma:
          <input type="number" name="sched_gamma" value="0.5" min="0.1" step="0.1">
        </label>
      </div>
    </div>

<!------------------------------------------------------ 🟥 평가하기 Pane ------------------------------------------------------>
    <!-- 🟥 평가하기 Pane -->
    <div class="pane" id="pane-eval" hidden>
      <!-- (필수) 메트릭 -->
      <div class="block block-eval block-required" id="block-metrics" data-active="true">
        <h3>평가 지표</h3>
        <label><input type="checkbox" name="metrics" value="accuracy" checked> Accuracy</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" name="metrics" value="precision"> Precision</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" name="metrics" value="recall"> Recall</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" name="metrics" value="f1"> F1-score</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" name="metrics" value="topk"> Top-K Accuracy</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" name="metrics" value="auc"> AUC (이진)</label>
      </div>

      <!-- 평균 방식 -->
      <div class="block block-eval" id="block-average" data-active="true">
        <h3>평균 방식 (Precision/Recall/F1)</h3>
        <select name="average">
          <option value="macro" selected>macro</option>
          <option value="micro">micro</option>
          <option value="weighted">weighted</option>
          <option value="binary">binary</option>
        </select>
      </div>

      <!-- Top-K 옵션 -->
      <div class="block block-eval" id="block-topk" data-active="true">
        <h3>Top-K Accuracy</h3>
        <label>K = <input type="number" name="topk_k" value="3" min="1" max="20"></label>
      </div>

      <!-- 리포트 & 혼동행렬 -->
      <div class="block block-eval" id="block-confmat" data-active="true">
        <h3>리포트 & 혼동행렬</h3>
        <label><input type="checkbox" name="show_classification_report" checked> classification_report 출력</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" name="show_confusion_matrix" checked> confusion_matrix 히트맵</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" name="cm_normalize"> 정규화(normalize)</label>
      </div>

      <!-- 시각화 -->
      <div class="block block-eval" id="block-visual" data-active="true">
        <h3>결과 시각화</h3>
        <label>예측 샘플 개수:
          <input type="number" name="viz_samples" value="10" min="0" max="50">
        </label>
        <label style="margin-left:0.5rem;">오분류 샘플 개수:
          <input type="number" name="viz_mis" value="5" min="0" max="50">
        </label>
      </div>

      <!-- 고급 설정 -->
      <div class="block block-eval" id="block-advanced" data-active="true">
        <h3>고급 설정</h3>
        <label>배치 크기: <input type="number" name="eval_batch" value="128" min="1"></label>
        <label style="margin-left:0.5rem;">클래스 수: <input type="number" name="num_classes" value="10" min="2"></label>
        <br>
        <label>라벨 이름(쉼표로 구분):</label>
        <input type="text" name="class_names" placeholder="예: 고양이,개,새">
        <br>
        <label><input type="checkbox" name="force_cpu"> 강제로 CPU 사용</label>
      </div>
    </div>

  </div>

  <!-- 변환하기 버튼 -->
  <!-- 단계별 변환 버튼 -->
  <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:1rem;">
    <button type="submit" class="btn" name="stage" value="pre">🟩 전처리만 변환</button>
    <button type="submit" class="btn" name="stage" value="model">🟦 모델설계만 변환</button>
    <button type="submit" class="btn" name="stage" value="train">🟧 학습만 변환</button>
    <button type="submit" class="btn" name="stage" value="eval">🟥 평가만 변환</button>
    <button type="submit" class="btn" name="stage" value="all">🔗 전체 변환</button>
  </div>
</form>

<!-- 🔹 사용자 ID 동기화 스크립트 -->
<script>
(function() {
  const userIdInput = document.getElementById('user-id-input');
  const hiddenUserIdInput = document.getElementById('hidden-user-id');
  
  // 사용자 ID 입력 시 숨겨진 필드와 동기화
  userIdInput.addEventListener('input', function() {
    let value = this.value;
    // 안전한 문자만 허용
    value = value.replace(/[^a-zA-Z0-9_-]/g, '');
    this.value = value;
    hiddenUserIdInput.value = value || 'anonymous';
  });
  
  // 초기 동기화
  hiddenUserIdInput.value = userIdInput.value || 'anonymous';
})();
</script>
